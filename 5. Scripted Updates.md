# Scripted Updates

*This is a bigger topic*. But here is an example. We can update the value of a key without knowing its value with scripts. We use <code>script</code> tag for that.

```sh
POST /products/_update/100
{
	"script":{
		"source":"ctx._source.in_stock--"
	}
}
```
The above script decreases value by one.
The double quote for <code>ctx._source.in_stock</code> can be put in triple quotes if multiple lines are needed for the script.

Running above script gives use:
```sh
{
  "_index" : "products",
  "_type" : "_doc",
  "_id" : "100",
  "_version" : 3,
  "result" : "updated",
  "_shards" : {
    "total" : 3,
    "successful" : 2,
    "failed" : 0
  },
  "_seq_no" : 3,
  "_primary_term" : 2
}
```
as output.


The values can be changed using scripted updates as well.
Check out below query:
```sh
POST /products/_update/100{
	"script":{
		"source":"ctx._source.in_stock = 10"
	}
}
```
Running this gives:
```sh
{
  "_index" : "products",
  "_type" : "_doc",
  "_id" : "100",
  "_version" : 5,
  "result" : "updated",
  "_shards" : {
    "total" : 3,
    "successful" : 2,
    "failed" : 0
  },
  "_seq_no" : 5,
  "_primary_term" : 2
}
```

The value can be changed via an application by sending parameters to the query.
For example, I can send 4 as a value to be subtracted from the <code>in_stock value</code>. To do that, I have to pass this value in <code>params</code> object:
```sh
POST/products/_update/100
{
	"script":{
		"source":"ctx._source.in_stock -= params.quantity",
		"params":{
			"quantity":4
		}
	}
}
```
Running above query gives me:
```sh
{
  "_index" : "products",
  "_type" : "_doc",
  "_id" : "100",
  "_version" : 6,
  "result" : "updated",
  "_shards" : {
    "total" : 3,
    "successful" : 2,
    "failed" : 0
  },
  "_seq_no" : 6,
  "_primary_term" : 2
}
```

##### IN CASE OF SCRIPTED UPDATES, YOU WOULD GET <code>result</code> AS <code>updated</code> NO MATTER IF THE NEW VALUE IS SAME AS OLD ONE.

We can write a query based on condition. For example:
```sh
POST /products/_update/100
{
  "script":{
    "source": """
      if(ctx._source.in_stock == 6){
        ctx.op = 'noop'
      }
      ctx._source.in_stock--;
    """
  }
}
```
The above script gives:
```sh
{
  "_index" : "products",
  "_type" : "_doc",
  "_id" : "100",
  "_version" : 6,
  "result" : "noop",
  "_shards" : {
    "total" : 0,
    "successful" : 0,
    "failed" : 0
  },
  "_seq_no" : 6,
  "_primary_term" : 2
}
```

If we do not add- <code>ctx.op = 'noop'</code>, it would always result in result: <code>updated</code>:
```sh
POST /products/_update/100
{
  "script":{
    "source": """
      if(ctx._source.in_stock>6){
        ctx._source.in_stock--;
      }
    """
  }
}
```
This gives:
```sh
{
  "_index" : "products",
  "_type" : "_doc",
  "_id" : "100",
  "_version" : 8,
  "result" : "updated",
  "_shards" : {
    "total" : 3,
    "successful" : 2,
    "failed" : 0
  },
  "_seq_no" : 8,
  "_primary_term" : 2
}
```

If you set the <code>ctx.op ='delete'</code> based on a condition, then that would cause the <code>document</code> to be deleted and the result would have <code>deleted</code> value.

```sh
POST /products/_update/100
{
  "script":{
    "source": """
      if(ctx._source.in_stock<1){
        ctx.op ='delete'
      }
	  ctx._source.in_stock--;
    """
  }
}
```
The above query means that if all products are sold, <code>in_stock</code> becomes 0, then the <code>document products</code> would be deleted.